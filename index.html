<script>
    // Önceki tanımlamalar (socket, myName, myLink vb.) buraya gelecek
    
    let xp = 0;
    let level = 1;
    let sawAngle = 0;
    let sawCount = 1; // Level atladıkça artacak

    const objectTypes = {
        PARA: { size: 30, hp: 1, xp: 15, color: '#f1c40f', label: '¢' },
        DISLI: { size: 55, hp: 4, xp: 40, color: '#bdc3c7', label: '⚙' },
        KASA: { size: 100, hp: 10, xp: 120, color: '#95a5a6', label: '▣' },
        REAKTOR: { size: 200, hp: 30, xp: 600, color: '#34495e', label: '☢' }
    };

    let worldObjects = [];
    for(let i=0; i<50; i++) {
        let t = Object.keys(objectTypes)[Math.floor(Math.random() * 4)];
        worldObjects.push({
            id: i,
            x: Math.random() * 2800 + 100,
            y: Math.random() * 2800 + 100,
            type: t,
            hp: objectTypes[t].hp
        });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(!playing) return requestAnimationFrame(draw);

        // Hareket (İçinden geçme aktif: pos.x ve y sınırları dışında engel yok)
        pos.x += joy.dx * (7 + level * 0.2); // Level atladıkça hızın da biraz artar
        pos.y += joy.dy * (7 + level * 0.2);
        
        // Dünya Sınırları
        pos.x = Math.max(0, Math.min(3000, pos.x));
        pos.y = Math.max(0, Math.min(3000, pos.y));
        
        socket.emit('playerMovement', pos);

        ctx.save();
        ctx.translate(canvas.width/2 - pos.x, canvas.height/2 - pos.y);

        // METAL EŞYALARI ÇİZ VE KIR
        worldObjects.forEach((obj, index) => {
            let t = objectTypes[obj.type];
            
            // Şeffaf metal efekti (İçinden geçildiği hissi için)
            ctx.globalAlpha = 0.8; 
            ctx.fillStyle = t.color;
            ctx.fillRect(obj.x, obj.y, t.size, t.size);
            ctx.strokeStyle = "rgba(0,0,0,0.3)";
            ctx.strokeRect(obj.x, obj.y, t.size, t.size);
            ctx.globalAlpha = 1.0;

            // TESTERE ÇARPIŞMASI
            sawAngle += 0.05; // Dönüş hızı
            for(let i=0; i < sawCount; i++) {
                let currentSawAngle = sawAngle + (i * Math.PI * 2 / sawCount);
                let sawX = pos.x + Math.cos(currentSawAngle) * 80;
                let sawY = pos.y + Math.sin(currentSawAngle) * 80;

                let dist = Math.hypot(sawX - (obj.x + t.size/2), sawY - (obj.y + t.size/2));
                if(dist < t.size/2 + 25) {
                    obj.hp -= 0.2;
                    if(obj.hp <= 0) {
                        xp += t.xp;
                        worldObjects.splice(index, 1);
                        // YENİ EŞYA ÜRET (Harita hiç boş kalmasın)
                        setTimeout(() => {
                           let newT = Object.keys(objectTypes)[Math.floor(Math.random() * 4)];
                           worldObjects.push({id: Date.now(), x: Math.random()*2800, y: Math.random()*2800, type: newT, hp: objectTypes[newT].hp});
                        }, 3000);
                        
                        // SEVİYE ATLAMA
                        if(xp >= level * 150) {
                            level++;
                            xp = 0;
                            if(level % 2 === 0) sawCount++; // Her 2 levelda bir yeni testere ekle
                        }
                    }
                }
            }
        });

        // TESTERELERİ ÇİZ
        for(let i=0; i < sawCount; i++) {
            let currentSawAngle = sawAngle + (i * Math.PI * 2 / sawCount);
            let sX = pos.x + Math.cos(currentSawAngle) * 80;
            let sY = pos.y + Math.sin(currentSawAngle) * 80;
            
            ctx.fillStyle = "#bdc3c7";
            ctx.beginPath();
            for(let j=0; j<8; j++) {
                let a = j * (Math.PI/4);
                ctx.lineTo(sX + Math.cos(a + sawAngle*3) * 20, sY + Math.sin(a + sawAngle*3) * 20);
            }
            ctx.closePath(); ctx.fill();
        }

        // KOSTÜMLER (Ronaldo/Messi)
        if(myHeroImg.complete) ctx.drawImage(myHeroImg, pos.x-25, pos.y-25, 50, 50);

        ctx.restore();

        // LEVEL UI
        ctx.fillStyle = "black";
        ctx.fillText(`LVL: ${level} - TESTERE: ${sawCount}`, 20, 80);

        requestAnimationFrame(draw);
    }
    draw();
</script>
